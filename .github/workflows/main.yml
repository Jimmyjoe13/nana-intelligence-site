name: Publier sur LinkedIn via n8n

on:
  push:
    branches:
      - main
    paths:
      - 'blog/*.html'

jobs:
  post-linkedin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Extract blog slugs
        id: extract
        run: |
          # Trouve tous les fichiers .html ajoutés dans /blog
          git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^blog/.*\.html$' | while read file; do
            slug=$(echo "$file" | sed 's/^blog\///' | sed 's/\.html$//')
            echo "slug=$slug" >> $GITHUB_OUTPUT
            # Déclenche un webhook par article
            curl -X POST ${{ secrets.N8N_WEBHOOK_URL }} \
              -H "Content-Type: application/json" \
              -d "{\"slug\": \"$slug\"}"
            echo "✅ Webhook envoyé pour $slug"
          done

        # Si aucun fichier trouvé
        if [ -z "$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^blog/.*\.html$')" ]; then
          echo "Aucun article détecté."
        fi
