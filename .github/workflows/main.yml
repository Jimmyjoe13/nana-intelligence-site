name: Publier sur LinkedIn via n8n

on:
  push:
    branches:
      - main
    paths:
      - 'blog/*.html'

jobs:
  post-linkedin:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ› ï¸ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Pour pouvoir comparer les commits

      - name: ðŸ” Trouver les nouveaux articles dans /blog
        id: find-articles
        run: |
          # Lister tous les fichiers .html ajoutÃ©s dans /blog
          NEW_ARTICLES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^blog/.*\.html$' || echo "")
          
          if [ -z "$NEW_ARTICLES" ]; then
            echo "âŒ Aucun nouvel article dÃ©tectÃ©."
            exit 1
          fi

          echo "âœ… Articles dÃ©tectÃ©s :"
          echo "$NEW_ARTICLES"

          # Extraire les slugs et envoyer un webhook par article
          echo "$NEW_ARTICLES" | while read file; do
            slug=$(echo "$file" | sed -E 's/^blog\/(.*)\.html$/\1/')
            echo "ðŸš€ Envoi du webhook pour : $slug"
            
            # Envoi du JSON avec le slug
            curl -X POST ${{ secrets.N8N_WEBHOOK_URL }} \
              -H "Content-Type: application/json" \
              -d "{\"slug\": \"$slug\"}" \
              --fail  # Pour que l'erreur soit dÃ©tectÃ©e
            sleep 2  # Ã‰vite les appels trop rapides
          done

          # Marquer que des articles ont Ã©tÃ© trouvÃ©s
          echo "articles_found=true" >> $GITHUB_OUTPUT
        continue-on-error: false
